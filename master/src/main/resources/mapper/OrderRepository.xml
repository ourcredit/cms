<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.monkey.core.mapper.OrderRepository">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.monkey.core.entity.Order">
        <id column="id" property="id"/>
        <result column="price" property="price"/>
        <result column="creationTime" property="creationTime"/>
        <result column="creatorUserId" property="creatorUserId"/>
        <result column="orderState" property="orderState"/>
        <result column="payState" property="payState"/>
        <result column="payType" property="payType"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, productName, productId, price, wechatOrder, creationTime, creatorUserId, orderState, payState, deviceId, deviceName, deviceType, pointName,payType,backNum,deviceNum,pointId
    </sql>
    <!--获取时间段统计数据-->
    <select id="getOrderStatical" resultType="com.monkey.core.dtos.TodayStatical">

        SELECT
        ( SELECT sum( price ) / 100 FROM v_getallorders
        <where>
            payState = 1
            <if test="start!=null">
                and creationTime >= #{start}
            </if>
            <if test="end!=null">
                and creationTime &lt;= #{end}
            </if>
        </where>) AS sale,
        ( SELECT count( 1 ) FROM v_getallorders   <where>
        payState = 1
        <if test="start!=null">
            and creationTime >= #{start}
        </if>
        <if test="end!=null">
            and creationTime &lt;= #{end}
        </if>
    </where>) AS count,
        (SELECT count(1) from sale_device
        <where>
        isdeleted=0
        <if test="start!=null">
            and creationTime >= #{start}
        </if>
        <if test="end!=null">
            and creationTime &lt;= #{end}
        </if>
        </where>
        ) device,
        ( SELECT count( 1 ) FROM sale_errorlog <where>
        logType=2
        <if test="start!=null">
            and creationTime >= #{start}
        </if>
        <if test="end!=null">
            and creationTime &lt;= #{end}
        </if>
    </where>) AS error,
        ( SELECT sum( 1 )  FROM v_getallorders   <where>
        payState = 2
        <if test="start!=null">
            and creationTime >= #{start}
        </if>
        <if test="end!=null">
            and creationTime &lt;= #{end}
        </if>
    </where>) AS off;
    </select>
    <!--获取销售额统计报表-->
    <select id="getTodaySalePercent" resultType="com.monkey.core.dtos.SalePercentDto">
        SELECT
        DATE_FORMAT( creationTime, '%H' ) as time,
        sum(price)/100 as count
        FROM
        v_getallorders
        <where>
            payState = 1
            <if test="start!=null">
                and creationTime >= #{start}
            </if>
            <if test="end!=null">
                and creationTime &lt;= #{end}
            </if>
        </where>
        GROUP BY
        DATE_FORMAT( creationTime, '%H' )
        ORDER BY
        DATE_FORMAT( creationTime, '%H' )
    </select>
    <!--获取当月统计信息-->
    <select id="getMonthSalePercent" resultType="com.monkey.core.dtos.SalePercentDto">
        SELECT
        DATE_FORMAT( creationTime, '%d' ) as time,
        sum(price)/100 as count
        FROM
        v_getallorders
        <where>
            payState = 1
            <if test="start!=null">
                and creationTime >= #{start}
            </if>
            <if test="end!=null">
                and creationTime &lt;= #{end}
            </if>
        </where>
        GROUP BY
        DATE_FORMAT( creationTime, '%d' )
        ORDER BY
        DATE_FORMAT( creationTime, '%d' )
    </select>
    <!--获取点位销售榜单前十-->
    <select id="getPointSalePercent" resultType="com.monkey.core.dtos.SalePercentDto">
        select pointName as time,COUNT(a.pointName) as count from sale_order  a
        <where>
            a.payState = 1 AND a.pointName IS NOT NULL 
            <if test="start!=null">
                and a.creationTime >= #{start}
            </if>
            <if test="end!=null">
                and a.creationTime &lt;= #{end}
            </if>
        </where>
        GROUP BY a.pointName ORDER BY COUNT(a.pointName) desc
        LIMIT 0,10
    </select>
    <!--获取支付类型统计-->
    <select id="getPayTypePercent" resultType="com.monkey.core.dtos.SalePercentDto">
        SELECT CASE payType
        WHEN 1 THEN
        '微信支付'
        ELSE
        '支付宝'
        END as time  ,
        COUNT( 1 ) as count
        FROM
        v_getallorders
        <where>
            payState = 1
            <if test="start!=null">
                and creationTime >= #{start}
            </if>
            <if test="end!=null">
                and creationTime &lt;= #{end}
            </if>
        </where>
        GROUP BY
        payType
    </select>

    <select id="getDeviceSaleStatical" resultType="com.monkey.core.dtos.DeviceSaleStatical">
        SELECT
        pointName,
        deviceName,
        deviceNum,
        deviceType,
        COUNT( productId ) saleCount,
        SUM( price ) saleMoney
        FROM
        sale_order
        <where>
            payState = 1
            AND orderState =1
            <if test="start!=null">
                and creationTime >= #{start}
            </if>
            <if test="end!=null">
                and creationTime &lt;= #{end}
            </if>
            <if test="deviceName!=null">
              and  deviceName like '%${deviceName}%'
            </if>
            <if test="pointName!=null">
                and pointName like '%${pointName}%'
            </if>
        </where>
        GROUP BY
        deviceName,
        deviceNum,
        pointName,
        deviceType
    </select>
    <select id="getProductSaleStatical" resultType="com.monkey.core.dtos.ProductSaleStatical">
        SELECT
        productId,
        productName,
        COUNT( a.productId ) saleCount,
        SUM( a.price ) saleMoney
        FROM
        sale_order a
        WHERE
        a.payState = 1
        AND a.orderState = 1
        <if test="start!=null">
            and a.creationTime >= #{start}
        </if>
        <if test="end!=null">
            and a.creationTime &lt;= #{end}
        </if>
        <if test="productName!=null">
            and a.productName like '%${productName}%'
        </if>
        GROUP BY
        a.productId,
        a.productName

    </select>
  <select id="getPointSaleStatical" resultType="com.monkey.core.dtos.ProductSaleStatical">
      SELECT
      a.pointName AS productName,
      b.saleCount AS saleCount,
      c.saleMoney AS saleMoney
      FROM
      sale_order a
      LEFT JOIN ( SELECT pointName, COUNT( 1 ) saleCount FROM sale_order WHERE payState = 1 GROUP BY pointName ) b ON a.pointName = b.pointName
      LEFT JOIN (
      SELECT
      pointName,
      SUM( CASE paytype WHEN 1 THEN price ELSE price * 100 END ) AS saleMoney
      FROM
      sale_order
      WHERE
      payState = 2
      GROUP BY
      pointName
      ) c ON a.pointName = c.pointName
      <where>
          1=1
          <if test="pointName!=null">
              and a.pointName like '%${pointName}%'
          </if>
          <if test="start!=null">
              and a.creationTime >= #{start}
          </if>
          <if test="end!=null">
              and a.creationTime &lt;= #{end}
          </if>
      </where>
      GROUP BY
      a.pointName
    </select>
</mapper>
